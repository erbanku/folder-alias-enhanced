# Folder Alias Enhanced - VSCode Extension Development Guide

## Project Overview

A VS Code extension that adds custom alias labels to folders/files in the Explorer tree. Uses **reactive-vscode** for reactive state management and file decoration APIs. Supports public (shared) and private (local) alias configurations in multi-root workspaces.

## Architecture & Core Components

### Entry Point (`src/index.ts`)

-   Uses `defineExtension` from reactive-vscode (not standard `activate`/`deactivate`)
-   Iterates all workspace folders, creates `.vscode/` dirs, and instantiates `useFileAlias()` per workspace
-   Auto-creates config files if settings enable it, auto-adds private config to `.gitignore`
-   Passes `fileAliasMap` (Map<workspaceUri, UseFileAliasReturn>) to `registerCommands()`

### File Decoration System (`src/file-alias.ts`)

-   **Core Hook:** `useFileAlias(uri)` returns reactive config refs + change emitter
-   Registers `FileDecorationProvider` that reads merged public+private configs
-   Truncates badges at 15 chars with `...` suffix, uses full description as tooltip
-   **Important:** Patches `FileDecoration.validate` to suppress badge length errors
-   Watches for config file changes with `useFsWatcher` to auto-reload

### Configuration Management (`src/hooks/useConfig.ts`)

-   Dual configs: `.vscode/public-folder-alias.json` (versioned) + `.vscode/private-folder-alias.json` (gitignored)
-   `configFile` is computed merge of public+private (private wins on conflicts via lodash `merge`)
-   Path keys are **workspace-relative** (e.g., `"src/components"`)
-   Config shape: `{ "path/to/folder": { description: "Alias", tooltip?: "...", icon?: "..." } }`

### Commands (`src/command/add-alias.command.ts`)

-   `folder-alias.addAlias`: Shows InputBox with eye/lock button to toggle public/private type
-   Respects `config.defaultAliasType` for initial state
-   Automatically detects edit vs. add by checking `hasAlias()`
-   `folder-alias.removeAlias`: Deletes from both configs
-   Both commands call `changeEmitter(uri)` to trigger decoration refresh

### Generated Code (`src/generated/meta.ts`)

-   Auto-generated by `vscode-ext-gen` (run via `pnpm update:gen`)
-   Exports typed constants for commands/configs from `package.json`
-   **Never edit manually** - update `package.json` then regenerate

## Development Workflow

### Build & Dev

```bash
pnpm build          # Production build with tsdown
pnpm dev            # Watch mode with sourcemaps
pnpm typecheck      # TypeScript validation (no emit)
pnpm lint           # ESLint check
```

### Testing & Debugging

-   Press **F5** in VS Code to launch Extension Development Host
-   Test multi-root workspaces by opening multiple folders
-   Check Output panel "Extension Host" for `console.log` statements (prefixed `[folder-alias]`)
-   Breakpoints work in TypeScript files during dev mode

### Publishing

```bash
pnpm pack           # Create .vsix for manual install
pnpm release        # Bump version + publish to marketplace
```

## Code Conventions

### Reactive Patterns

-   Use `ref()`, `computed()`, and reactive hooks from `reactive-vscode`
-   Call `useCommand()` to register commands (not `registerCommand`)
-   Use `useEventEmitter()` for file decoration change notifications

### Path Handling

-   **Always** use `pathe` (cross-platform) or `ufo` (URL utils) for paths
-   Store workspace-relative paths in configs (strip workspace prefix)
-   Use `uri.toString()` for Map keys (workspace folder lookup)

### Config File Operations

-   Read with `destr()` (safe JSON parsing with fallback)
-   Write with `JSON.stringify(config, null, 4)` for formatting
-   Always check `existsSync()` before reads, create dirs with `{ recursive: true }`

### Logging

-   Prefix all logs with `[folder-alias]` for filtering
-   Log command triggers, context resolution, and file writes for debugging
-   Keep production logs minimal (remove verbose logs before release)

## Extension-Specific Patterns

### Multi-Root Workspace Support

-   Each workspace gets its own `UseFileAliasReturn` instance in the Map
-   Look up context via `vscode.workspace.getWorkspaceFolder(uri)` then map.get()
-   Commands receive URIs - always resolve to workspace first

### Config Type Switching

-   UI shows eye icon (public) or lock icon (private) with tooltip indicating default
-   Clicking button toggles between types before accepting input
-   When saving, **delete from opposite config** to prevent duplicates

### File Decoration Validation Patch

The extension patches VSCode's internal validation:

```typescript
FileDecoration.validate = (d: FileDecoration): void => {
    // Suppressed badge length error to allow 15-char limit
};
```

This is necessary because the extension truncates at 15 chars (not 2 as VSCode expects).

## Key Dependencies

-   `reactive-vscode`: Reactive state management + Vue 3-style composition API
-   `tsdown`: Fast TypeScript bundler (replaces esbuild)
-   `vscode-ext-gen`: Auto-generates typed constants from package.json
-   `pathe`: Cross-platform path utilities
-   `ufo`: URL/path joining with consistent behavior
-   `destr`: Safe JSON parsing with automatic type inference

## Settings Schema

Users can configure via VS Code settings:

-   `folder-alias-enhanced.enable`: Master toggle (default: true)
-   `folder-alias-enhanced.defaultAliasType`: "public" | "private" (default: "public")
-   `folder-alias-enhanced.autoCreatePublicConfig`: Create public config on activation (default: false)
-   `folder-alias-enhanced.autoCreatePrivateConfig`: Create private config on activation (default: false)
-   `folder-alias-enhanced.autoAddPrivateToGitignore`: Auto-update .gitignore (default: true)

Access via `config` object from `src/config.ts` (reactive updates).
